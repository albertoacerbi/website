<script>
document.addEventListener("DOMContentLoaded", function() {
  // Find all Altmetric badges
  const badges = document.querySelectorAll('.altmetric-embed');

  badges.forEach(badge => {
    const doi = badge.getAttribute('data-doi');
    if (!doi) return;

    // Create small score badge before the donut, if not already present
    const scoreBadge = document.createElement('div');
    scoreBadge.className = 'altmetric-embed inline-block align-middle mr-2';
    scoreBadge.setAttribute('data-badge-type', 'score');
    scoreBadge.setAttribute('data-doi', doi);
    scoreBadge.setAttribute('data-link-target', '_blank');
    scoreBadge.style.display = 'inline-block';

    badge.parentNode.insertBefore(scoreBadge, badge);

    // Fetch additional data
    fetch(`https://api.altmetric.com/v1/doi/${encodeURIComponent(doi)}`)
      .then(res => res.json())
      .then(data => {
        const tweets = data.cited_by_tweeters_count || 0;
        const bluesky = data.cited_by_bsky_users_count || 0;
        const mendeley = data.readers?.mendeley || 0;

        // Skip if all counts are zero
        if (tweets + bluesky + mendeley === 0) return;

        const info = document.createElement('p');
        info.className = 'altmetric-stats text-sm text-gray-600 mt-2';
        info.style.fontSize = '0.9rem';
        info.style.color = '#666';
        info.innerHTML = `
          Posted by ${tweets} X users<br>
          Referenced by ${bluesky} Bluesky users<br>
          ${mendeley} readers on Mendeley
        `;
        badge.insertAdjacentElement('afterend', info);
      })
      .catch(err => console.error('Altmetric fetch failed', err));
  });
});
</script>